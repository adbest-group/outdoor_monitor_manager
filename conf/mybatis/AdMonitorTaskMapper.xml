<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.bt.om.mapper.AdMonitorTaskMapper">
    <resultMap id="BaseResultMap" type="com.bt.om.entity.AdMonitorTask">
        <!-- WARNING - @mbggenerated This element is automatically generated by
            MyBatis Generator, do not modify. This element was generated on Sat Jan 20
            10:48:02 CST 2018. -->
        <id column="id" property="id" jdbcType="INTEGER"/>
        <result column="activity_id" property="activityId" jdbcType="INTEGER"/>
        <result column="activity_adseat_id" property="activityAdseatId" jdbcType="INTEGER"/>
        <result column="task_type" property="taskType" jdbcType="INTEGER"/>
        <result column="monitor_date" property="monitorDate" jdbcType="TIMESTAMP"/>
        <result column="monitor_last_days" property="monitorLastDays" jdbcType="INTEGER"/>
        <result column="user_id" property="userId" jdbcType="INTEGER"/>
        <result column="status" property="status" jdbcType="INTEGER"/>
        <result column="verify_time" property="verifyTime" jdbcType="TIMESTAMP"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
        <result column="problem_status" property="problemStatus" jdbcType="INTEGER"/>
        <result column="sub_created" property="subCreated" jdbcType="INTEGER"/>
        <result column="parent_id" property="parentId" jdbcType="INTEGER"/>
        <result column="parent_type" property="parentType" jdbcType="INTEGER"/>
        <result column="assessor_id" property="assessorId" jdbcType="INTEGER"/>
        <result column="assignor_id" property="assignorId" jdbcType="INTEGER"/>
    </resultMap>
    <sql id="Base_Column_List">
        <!-- WARNING - @mbggenerated This element is automatically generated by
            MyBatis Generator, do not modify. This element was generated on Sat Jan 20
            10:48:02 CST 2018. -->
        id, activity_id, activity_adseat_id, task_type, monitor_date,monitor_last_days,user_id,
        status,problem_status,sub_created,parent_id,parent_type,
        verify_time,create_time, update_time,assessor_id,assignor_id
    </sql>
    <select id="selectByPrimaryKey" resultMap="BaseResultMap"
            parameterType="java.lang.Integer">
        <!-- WARNING - @mbggenerated This element is automatically generated by
            MyBatis Generator, do not modify. This element was generated on Sat Jan 20
            10:48:02 CST 2018. -->
        select
        <include refid="Base_Column_List"/>
        from ad_monitor_task
        where id = #{id,jdbcType=INTEGER}
    </select>
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
        <!-- WARNING - @mbggenerated This element is automatically generated by
            MyBatis Generator, do not modify. This element was generated on Sat Jan 20
            10:48:02 CST 2018. -->
        delete from ad_monitor_task
        where id = #{id,jdbcType=INTEGER}
    </delete>
    <insert id="insert" parameterType="com.bt.om.entity.AdMonitorTask">
        <!-- WARNING - @mbggenerated This element is automatically generated by
            MyBatis Generator, do not modify. This element was generated on Sat Jan 20
            10:48:02 CST 2018. -->
        insert into ad_monitor_task (id, activity_id, activity_adseat_id,
        task_type,monitor_date,monitor_last_days, user_id, status,problem_status,sub_created,parent_id,parent_type,
        verify_time,create_time, update_time,assessor_id,assignor_id)
        values
        (
        #{id,jdbcType=INTEGER}, #{activityId,jdbcType=INTEGER},
        #{activityAdseatId,jdbcType=INTEGER},
        #{taskType,jdbcType=INTEGER},
        #{monitorDate,jdbcType=TIMESTAMP},
        #{monitorLastDays,jdbcType=INTEGER},
        #{userId,jdbcType=INTEGER}, #{status,jdbcType=INTEGER},
        #{problemStatus,jdbcType=INTEGER},#{subCreated,jdbcType=INTEGER},
        #{parentId,jdbcType=INTEGER}, #{parentType,jdbcType=INTEGER},
        #{verifyTime,jdbcType=TIMESTAMP},#{createTime,jdbcType=TIMESTAMP},
        #{updateTime,jdbcType=TIMESTAMP},#{assessorId,jdbcType=INTEGER},#{assignorId,jdbcType=INTEGER}
    	)
    </insert>
    <insert id="insertSelective" parameterType="com.bt.om.entity.AdMonitorTask">
        <!-- WARNING - @mbggenerated This element is automatically generated by
            MyBatis Generator, do not modify. This element was generated on Sat Jan 20
            10:48:02 CST 2018. -->
        insert into ad_monitor_task
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="id != null">
                id,
            </if>
            <if test="activityId != null">
                activity_id,
            </if>
            <if test="activityAdseatId != null">
                activity_adseat_id,
            </if>
            <if test="taskType != null">
                task_type,
            </if>
            <if test="monitorDate != null">
                monitor_date,
            </if>
            <if test="monitorLastDays != null">
                monitor_last_days,
            </if>
            <if test="userId != null">
                user_id,
            </if>
            <if test="status != null">
                status,
            </if>
            <if test="problemStatus != null">
                problem_status,
            </if>
            <if test="subCreated != null">
                sub_created,
            </if>
            <if test="parentId != null">
                parent_id,
            </if>
            <if test="parentType != null">
                parent_type,
            </if>
            <if test="verifyTime != null">
                verify_time,
            </if>
            <if test="createTime != null">
                create_time,
            </if>
            <if test="updateTime != null">
                update_time,
            </if>
             <if test="assessorId != null">
                assessorId,
            </if>
             <if test="assignorId != null">
                assignorId
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="id != null">
                #{id,jdbcType=INTEGER},
            </if>
            <if test="activityId != null">
                #{activityId,jdbcType=INTEGER},
            </if>
            <if test="activityAdseatId != null">
                #{activityAdseatId,jdbcType=INTEGER},
            </if>
            <if test="taskType != null">
                #{taskType,jdbcType=INTEGER},
            </if>
            <if test="monitorDate != null">
                #{monitorDate,jdbcType=TIMESTAMP},
            </if>
            <if test="monitorLastDays != null">
                #{monitorLastDays,jdbcType=INTEGER},
            </if>
            <if test="userId != null">
                #{userId,jdbcType=INTEGER},
            </if>
            <if test="status != null">
                #{status,jdbcType=INTEGER},
            </if>
            <if test="problemStatus != null">
                #{problemStatus,jdbcType=INTEGER},
            </if>
            <if test="subCreated != null">
                #{subCreated,jdbcType=INTEGER},
            </if>
            <if test="parentId != null">
                #{parentId,jdbcType=INTEGER},
            </if>
            <if test="parentType != null">
                #{parentType,jdbcType=INTEGER},
            </if>
            <if test="verifyTime != null">
                #{verifyTime,jdbcType=TIMESTAMP},
            </if>
            <if test="createTime != null">
                #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                #{updateTime,jdbcType=TIMESTAMP},
            </if>
             <if test="assessorId != null">
                #{assessorId,jdbcType=INTEGER},
            </if>
             <if test="assignorId != null">
                #{assignorId,jdbcType=INTEGER}
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.bt.om.entity.AdMonitorTask">
        <!-- WARNING - @mbggenerated This element is automatically generated by
            MyBatis Generator, do not modify. This element was generated on Sat Jan 20
            10:48:02 CST 2018. -->
        update ad_monitor_task
        <set>
            <if test="activityId != null">
                activity_id = #{activityId,jdbcType=INTEGER},
            </if>
            <if test="activityAdseatId != null">
                activity_adseat_id =
                #{activityAdseatId,jdbcType=INTEGER},
            </if>
            <if test="taskType != null">
                task_type = #{taskType,jdbcType=INTEGER},
            </if>
            <if test="monitorDate != null">
                monitor_date = #{monitorDate,jdbcType=TIMESTAMP},
            </if>
            <if test="monitorLastDays != null">
                monitor_last_days = #{monitorLastDays,jdbcType=INTEGER},
            </if>
            <if test="userId != null">
                user_id = #{userId,jdbcType=INTEGER},
            </if>
            <if test="status != null">
                status = #{status,jdbcType=INTEGER},
            </if>
            <if test="problemStatus != null">
                problem_status = #{problemStatus,jdbcType=INTEGER},
            </if>
            <if test="subCreated != null">
                sub_created = #{subCreated,jdbcType=INTEGER},
            </if>
            <if test="parentId != null">
                parent_id = #{parentId,jdbcType=INTEGER},
            </if>
            <if test="parentType != null">
                parent_type = #{parentType,jdbcType=INTEGER},
            </if>
            <if test="verifyTime != null">
                verify_time = #{verifyTime,jdbcType=TIMESTAMP},
            </if>
            <if test="createTime != null">
                create_time = #{createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="updateTime != null">
                update_time = #{updateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="assessorId != null">
                assessor_id = #{assessorId,jdbcType=INTEGER},
            </if>
            <if test="assignorId != null">
               assignor_id = #{assignorId,jdbcType=INTEGER}
            </if>
        </set>
        where id = #{id,jdbcType=INTEGER}
    </update>
    <update id="updateByPrimaryKey" parameterType="com.bt.om.entity.AdMonitorTask">
        <!-- WARNING - @mbggenerated This element is automatically generated by
            MyBatis Generator, do not modify. This element was generated on Sat Jan 20
            10:48:02 CST 2018. -->
        update ad_monitor_task
        set activity_id =
        #{activityId,jdbcType=INTEGER},
        activity_adseat_id =
        #{activityAdseatId,jdbcType=INTEGER},
        task_type =
        #{taskType,jdbcType=INTEGER},
        monitor_date = #{monitorDate,jdbcType=TIMESTAMP},
        monitor_last_days = #{monitorLastDays,jdbcType=INTEGER},
        user_id = #{userId,jdbcType=INTEGER},
        status = #{status,jdbcType=INTEGER},
        problem_status = #{problemStatus,jdbcType=INTEGER},
        sub_created = #{subCreated,jdbcType=INTEGER},
        parent_id = #{parentId,jdbcType=INTEGER},
        parent_type = #{parentType,jdbcType=INTEGER},
        verify_time =
        #{verifyTime,jdbcType=TIMESTAMP},
        create_time =
        #{createTime,jdbcType=TIMESTAMP},
        update_time =
        #{updateTime,jdbcType=TIMESTAMP},
        assessor_id =
        #{assessorId,jdbcType=INTEGER},
        assignorid =
        #{assignorId,jdbcType=INTEGER}
        where id = #{id,jdbcType=INTEGER}   
    </update>
    <update id="cancelAdMonitorTaskByAssessorId"  parameterType="java.lang.Integer">
        update ad_monitor_task
        set assessor_id = null 
  		where status = 3 and id = #{id,jdbcType=INTEGER}
    </update>
     <update id="cancelAdMonitorTaskByAssignorId"  parameterType="java.lang.Integer">
        update ad_monitor_task
        set assignor_id = null 
  		where status = 1 and id = #{id,jdbcType=INTEGER}	
    </update>
    <resultMap id="ExtResultMap" extends="BaseResultMap"
               type="com.bt.om.entity.vo.AdMonitorTaskVo">
        <result column="activity_name" jdbcType="VARCHAR" property="activityName"/>
        <result column="sample_pic_url" jdbcType="VARCHAR" property="samplePicUrl"/>
        <result column="start_time" jdbcType="TIMESTAMP" property="startTime"/>
        <result column="end_time" jdbcType="TIMESTAMP" property="endTime"/>
        <result column="province" jdbcType="BIGINT" property="province"/>
        <result column="city" jdbcType="BIGINT" property="city"/>
        <result column="region" jdbcType="BIGINT" property="region"/>
        <result column="street" jdbcType="BIGINT" property="street"/>
        <result column="location" jdbcType="VARCHAR" property="location"/>
        <result column="media_id" jdbcType="INTEGER" property="mediaId"/>
        <result column="media_name" jdbcType="VARCHAR" property="mediaName"/>
        <result column="ad_seat_name" jdbcType="VARCHAR" property="adSeatName"/>
        <result column="realname" jdbcType="VARCHAR" property="realname"/>
        <result column="monitor_start" jdbcType="TIMESTAMP" property="monitorsStart"/>
        <result column="monitor_end" jdbcType="TIMESTAMP" property="monitorsEnd"/>
        <result column="brand" jdbcType="VARCHAR" property="brand"/>
        <result column="status" jdbcType="INTEGER" property="status"/>
        <result column="reason" jdbcType="VARCHAR" property="reason"/>
        <result column="problem" jdbcType="VARCHAR" property="problem"/>
        <result column="problem_other" jdbcType="VARCHAR" property="problemOther"/>
        <result column="pic_url1" jdbcType="VARCHAR" property="picUrl1"/>
        <result column="pic_url2" jdbcType="VARCHAR" property="picUrl2"/>
        <result column="pic_url3" jdbcType="VARCHAR" property="picUrl3"/>
        <result column="pic_url4" jdbcType="VARCHAR" property="picUrl4"/>
        <result column="feedbackstatus" jdbcType="INTEGER" property="feedbackStatus"/>
        <result column="feedbackcreatetime" jdbcType="TIMESTAMP" property="feedbackCreateTime"/>
        <result column="lat" jdbcType="DOUBLE" property="lat"/>
        <result column="lon" jdbcType="DOUBLE" property="lon"/>
        <result column="feedback_lat" jdbcType="DOUBLE" property="feedbackLat"/>
        <result column="feedback_lon" jdbcType="DOUBLE" property="feedbackLon"/>
        <result column="assessorName" jdbcType="VARCHAR" property="assessorName"/>
        <result column="assignorName" jdbcType="VARCHAR" property="assignorName"/>
    </resultMap>

    <resultMap id="MobileResultMap" extends="BaseResultMap" type="com.bt.om.entity.vo.AdMonitorTaskMobileVo">
        <result column="activity_name" jdbcType="VARCHAR" property="activityName"/>
        <result column="sample_pic_url" jdbcType="VARCHAR" property="samplePicUrl"/>
        <result column="monitor_start" jdbcType="VARCHAR" property="monitorStart"/>
        <result column="monitor_end" jdbcType="VARCHAR" property="monitorEnd"/>
        <result column="ad_seat_id" jdbcType="INTEGER" property="adSeatId"/>
        <result column="ad_seat_code" jdbcType="INTEGER" property="adSeatCode"/>
        <result column="ad_seat_name" jdbcType="VARCHAR" property="adSeatName"/>
        <result column="ad_seat_location" jdbcType="VARCHAR" property="adSeatLocation"/>
        <result column="lat" jdbcType="DOUBLE" property="lat"/>
        <result column="lon" jdbcType="DOUBLE" property="lon"/>
        <result column="pic_url1" jdbcType="VARCHAR" property="picUrl1"/>
        <result column="pic_url2" jdbcType="VARCHAR" property="picUrl2"/>
        <result column="pic_url3" jdbcType="VARCHAR" property="picUrl3"/>
        <result column="pic_url4" jdbcType="VARCHAR" property="picUrl4"/>
        <result column="feedback_time" jdbcType="VARCHAR" property="feedbackTime"/>
        <result column="reason" jdbcType="VARCHAR" property="reason"/>
        <result column="problem" jdbcType="VARCHAR" property="problem"/>
        <result column="problem_other" jdbcType="VARCHAR" property="problemOther"/>
        <result column="feedback_lat" jdbcType="DOUBLE" property="feedbackLat"/>
        <result column="feedback_lon" jdbcType="DOUBLE" property="feedbackLon"/>
        <result column="distance" jdbcType="DOUBLE" property="distance"/>
        <result column="province" jdbcType="BIGINT" property="province"/>
        <result column="city" jdbcType="BIGINT" property="city"/>
        <result column="region" jdbcType="BIGINT" property="region"/>
        <result column="street" jdbcType="BIGINT" property="street"/>
        <result column="start_time" jdbcType="TIMESTAMP" property="startTime"/>
        <result column="end_time" jdbcType="TIMESTAMP" property="endTime"/>
        <result column="assign_type" jdbcType="INTEGER" property="assignType"/>
        <result column="ad_code_flag" jdbcType="INTEGER" property="adCodeFlag"/>
        <result column="memo" jdbcType="VARCHAR" property="memo"/>
    </resultMap>

    <insert id="insertList" parameterType="java.util.List">
        insert into ad_monitor_task (id, activity_id, activity_adseat_id,
        task_type, user_id, status,problem_status,sub_created,parent_id,parent_type,
        verify_time,create_time, update_time)
        values
        <foreach collection="tasks" item="task" separator=",">
            (#{id,jdbcType=INTEGER}, #{activityId,jdbcType=INTEGER}, #{activityAdseatId,jdbcType=INTEGER},
            #{taskType,jdbcType=INTEGER}, #{userId,jdbcType=INTEGER}, #{status,jdbcType=INTEGER},
            #{problemStatus,jdbcType=INTEGER}, #{subCreated,jdbcType=INTEGER}, #{parentId,jdbcType=INTEGER},
            #{parentType,jdbcType=INTEGER},
            #{verifyTime,jdbcType=TIMESTAMP},#{createTime,jdbcType=TIMESTAMP}, #{updateTime,jdbcType=TIMESTAMP}),#{assessorId,jdbcType=INTEGER},#{assignorId,jdbcType=INTEGER}
        </foreach>
    </insert>

    <delete id="deleteByActivityId" parameterType="java.lang.Integer">
		delete from
		ad_monitor_task
		where activity_id = #{activityId,jdbcType=INTEGER}
	</delete>

    <select id="getPageCount" parameterType="map" resultType="int">
        select count(a.id)
        from ad_monitor_task a
        left join ad_activity b on
        a.activity_id = b.id
        left join ad_activity_adseat c on
        a.activity_adseat_id = c.id
        left join ad_seat_info d on c.ad_seat_id =
        d.id
        left join ad_media e on c.media_id = e.id
        where 1=1
        <if test="activityId != null">
            and a.activity_id = #{activityId,jdbcType=INTEGER}
        </if>
        <if test="status != null and status==8">
            and a.status = #{status,jdbcType=INTEGER}
        </if>
        <if test="status != null and status==0">
            and a.status != 1
        </if>
        <if test="statuses != null">
            and a.status in
            <foreach collection="statuses" separator="," open="(" close=")" item="s">#{s,jdbcType=INTEGER}
            </foreach>
        </if>
        <if test="problemStatus != null">
            and a.problem_status = #{problemStatus,jdbcType=INTEGER}
        </if>
        <if test="problemStatuses != null">
            and a.problem_status in
            <foreach collection="problemStatuses" separator="," open="(" close=")" item="ps">#{ps,jdbcType=INTEGER}
            </foreach>
        </if>
        <if test="taskType != null">
            and a.task_type = #{taskType,jdbcType=INTEGER}
        </if>
        <if test="mediaUserId != null">
            and e.user_id = #{mediaUserId,jdbcType=INTEGER}
        </if>
        <if test="taskTypes != null">
            and a.task_type in
            <foreach collection="taskTypes" separator="," open="(" close=")" item="task">#{task,jdbcType=INTEGER}
            </foreach>
        </if>
        <if test="parentId != null">
            and a.parent_id = #{parentId,jdbcType=INTEGER}
        </if>
        <if test="parentType != null">
            and a.parent_type = #{parentType,jdbcType=INTEGER}
        </if>
        <if test="idpid != null">
            and (a.id = #{idpid,jdbcType=INTEGER} or a.parent_id = #{idpid,jdbcType=INTEGER} and a.parent_type=1)
        </if>
        <if test="startDate != null">
            and b.start_time >= DATE_FORMAT(#{startDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>
        <if test="endDate != null">
            and b.end_time &lt;= DATE_FORMAT(#{endDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>
        <if test="assessorId != null" >
	      	and a.assessor_id = #{assessorId,jdbcType=INTEGER}
	    </if>
	    <if test="assignorId != null" >
	      	and a.assignor_id = #{assignorId,jdbcType=INTEGER}
	    </if>
    </select>

    <select id="getPageData" parameterType="map" resultMap="ExtResultMap">
        select 
        	a.id, a.activity_id, a.activity_adseat_id, a.task_type, a.monitor_date,a.monitor_last_days,a.user_id,
        	a.status,a.problem_status,a.sub_created,a.parent_id,a.parent_type, a.verify_time, a.create_time, a.update_time, a.assessor_id,a.assignor_id,
        	b.activity_name,c.sample_pic_url,b.start_time,b.end_time,d.province,d.city,d.region,d.street,c.media_id,e.media_name,d.`name`
        	as ad_seat_name,
        	f.realname,
        	g.realname as assessorName,
        	h.realname as assignorName
        from ad_monitor_task a
	        left join ad_activity b on a.activity_id = b.id
	        left join ad_activity_adseat c on a.activity_adseat_id = c.id
	        left join ad_seat_info d on c.ad_seat_id = d.id
	        left join ad_media e on c.media_id = e.id
	        left join sys_user_execute f on a.user_id = f.id
	        left join sys_user g on a.assessor_id = g.id
	        left join sys_user h on a.assignor_id = h.id
        where 1=1
        <if test="activityId != null">
            and a.activity_id = #{activityId,jdbcType=INTEGER}
        </if>
        <if test="status != null and status==8">
            and a.status = #{status,jdbcType=INTEGER}
        </if>
        <if test="status != null and status==0">
            and a.status != 1
        </if>
        <if test="statuses != null">
            and a.status in
            <foreach collection="statuses" separator="," open="(" close=")" item="s">#{s,jdbcType=INTEGER}
            </foreach>
        </if>
        <if test="problemStatus != null">
            and a.problem_status = #{problemStatus,jdbcType=INTEGER}
        </if>
        <if test="problemStatuses != null">
            and a.problem_status in
            <foreach collection="problemStatuses" separator="," open="(" close=")" item="ps">#{ps,jdbcType=INTEGER}
            </foreach>
        </if>
        <if test="taskType != null">
            and a.task_type = #{taskType,jdbcType=INTEGER}
        </if>
        <if test="mediaUserId != null">
            and e.user_id = #{mediaUserId,jdbcType=INTEGER} and a.parent_id is null
        </if>
        <if test="taskTypes != null">
            and a.task_type in
            <foreach collection="taskTypes" separator="," open="(" close=")" item="task">#{task,jdbcType=INTEGER}
            </foreach>
        </if>
        <if test="parentId != null">
            and a.parent_id = #{parentId,jdbcType=INTEGER}
        </if>
        <if test="parentType != null">
            and a.parent_type = #{parentType,jdbcType=INTEGER}
        </if>
        <if test="idpid != null">
            and (a.id = #{idpid,jdbcType=INTEGER} or a.parent_id = #{idpid,jdbcType=INTEGER} and a.parent_type=1)
        </if>
        <if test="startDate != null">
            and b.start_time >= DATE_FORMAT(#{startDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>
        <if test="endDate != null">
            and b.end_time &lt;= DATE_FORMAT(#{endDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>
        <if test="assessorId != null" >
	      	and a.assessor_id = #{assessorId,jdbcType=INTEGER}
	    </if>
	    <if test="assignorId != null" >
	      	and a.assignor_id = #{assignorId,jdbcType=INTEGER}
	    </if>
        order by a.update_time desc,a.id desc
    </select>

    <select id="selectByUserId" resultMap="MobileResultMap">
    select 
    	a.id, a.activity_id, a.activity_adseat_id, a.task_type, a.monitor_date,a.monitor_last_days,a.user_id, a.status,a.problem_status,a.sub_created,
    	a.parent_id,a.parent_type, a.verify_time, a.create_time, a.update_time,
    	b.activity_name,
    	c.sample_pic_url,c.monitor_start,c.monitor_end,c.ad_seat_id,
    	d.`name` as ad_seat_name, d.location as ad_seat_location, d.ad_code as ad_seat_code, d.lon, d.lat, d.region, d.street, d.province, d.city, 
    	d.ad_code_flag, d.memo,
    	e.reason,e.pic_url1,e.pic_url2,e.pic_url3,e.pic_url4,e.create_time as feedback_time,
    	e.problem,e.problem_other,e.lon as feedback_lon,e.lat as feedback_lat,
    	f.start_time, f.end_time, f.assign_type
    from ad_monitor_task a
    left join ad_activity b on a.activity_id = b.id
    left join ad_activity_adseat c on a.activity_adseat_id = c.id
    left join ad_seat_info d on c.ad_seat_id = d.id
    left join ad_monitor_task_feedback e on e.monitor_task_id = a.id and e.`status` = 1
    left join ad_monitor_user_task f on f.monitor_task_id = a.id
    where a.user_id = #{userId,jdbcType=INTEGER} and f.status = 1
    order by a.update_time desc,a.id desc
  </select>

    <select id="getTaskDetails" resultMap="ExtResultMap">
		select
			task.id,task.parent_id,task.parent_type,task.task_type,task.monitor_date,task.monitor_last_days,
			activity.`activity_name`,
			activity.`start_time`, 
			activity.`end_time`, 
			activity.`create_time`,
			`adseat`.`monitor_start`,
			`adseat`.`monitor_end`,
			`adseat`.`brand`,
			`adseat`.`sample_pic_url`,
			`seatinfo`.`province`,
			`seatinfo`.`city`,
			`seatinfo`.`region`,
			`seatinfo`.`street`,
			`seatinfo`.`location`,
			seatinfo.name,
			`media`.`media_name`
		from 
			ad_monitor_task as task 
			left join `ad_activity` as activity on task.`activity_id`=`activity`.id
			left join ad_activity_adseat as adseat on task.activity_adseat_id=adseat.id
			left join ad_seat_info as seatinfo on adseat.ad_seat_id =seatinfo.id
			left join ad_media as media on adseat.media_id=media.id
		where 
			task.id=#{taskId,jdbcType=INTEGER}

	</select>

    <select id="getSubmitDetails" resultMap="ExtResultMap">
		select
			task.status,
			activity.activity_name,
			seatinfo.province,
			seatinfo.city,
			seatinfo.region,
			seatinfo.street,
			adseat.monitor_start,
			feedback.problem,
			feedback.pic_url1,
			feedback.pic_url2,
			feedback.pic_url3,
			feedback.pic_url4,
			feedback.problem_other,
			feedback.create_time feedbackcreatetime,
			feedback.status feedbackstatus,
			task.task_type,
			feedback.reason,
			feedback.seat_lon as lon,
			feedback.seat_lat as lat,
            feedback.lon as feedback_lon,
            feedback.lat as feedback_lat
		from
			ad_monitor_task_feedback feedback
            left join `ad_monitor_task` as task on task.id=feedback.monitor_task_id
			left join ad_activity as activity on task.activity_id=activity.id
		    left join ad_activity_adseat as adseat on task.activity_adseat_id=adseat.id
		    left join ad_seat_info as seatinfo on adseat.ad_seat_id=seatinfo.id
		where
			task.id=#{taskId,jdbcType=INTEGER}
	</select>

    <select id="selectVoByParent" resultMap="ExtResultMap">
        select a.id, a.activity_id, a.activity_adseat_id, a.task_type,a.monitor_date,a.monitor_last_days, a.user_id,
        a.status,a.problem_status,a.sub_created,a.parent_id,a.parent_type,
        a.verify_time,a.create_time, a.update_time,a.assessor_id,a.assignor_id,
        b.pic_url1,b.pic_url2,b.pic_url3,b.pic_url4,b.create_time as feedbackcreatetime,b.reason,
        b.problem,b.problem_other,b.lon,b.lat,c.realname
        from ad_monitor_task a
        inner join ad_monitor_task_feedback b on a.id = b.monitor_task_id and b.`status` = 1
        left join sys_user_execute c on a.user_id = c.id
        where a.parent_id = #{parentId,jdbcType=INTEGER}
        and a.parent_type = #{parentType,jdbcType=INTEGER}

    </select>

    <select id="selectVoByPrimaryKey" resultMap="ExtResultMap">
        select a.id, a.activity_id, a.activity_adseat_id, a.task_type,a.monitor_date,a.monitor_last_days, a.user_id,
        a.status,a.problem_status,a.sub_created,a.parent_id,a.parent_type,
        a.verify_time,a.create_time, a.update_time,a.assessor_id,a.assignor_id,
        b.pic_url1,b.pic_url2,b.pic_url3,b.pic_url4,b.create_time as feedbackcreatetime,b.reason,
        b.problem,b.problem_other,b.lon,b.lat,c.realname
        from ad_monitor_task a
        inner join ad_monitor_task_feedback b on a.id = b.monitor_task_id and b.`status` = 1
        left join sys_user_execute c on a.user_id = c.id
        where a.id = #{id,jdbcType=INTEGER}

    </select>

    <update id="activeTask">
        update ad_monitor_task a
        set status = 1,
            update_time = sysdate()
        where a.activity_adseat_id = #{activitySeatId,jdbcType=INTEGER}
        and a.status = 7
    </update>

    <select id="getByPointAroundPageCount" parameterType="map" resultType="int">
        select count(1) from (
        select st_distance(point(lon,lat),point(#{lon,jdbcType=DOUBLE},#{lat,jdbcType=DOUBLE}))*111195 as distance
        from (
        select d.lon,d.lat
        from ad_monitor_task a
        left join ad_activity b on a.activity_id = b.id
        left join ad_activity_adseat c on a.activity_adseat_id = c.id
        left join ad_seat_info d on c.ad_seat_id = d.id

        where a.status = 8
        and d.lon between (#{lon,jdbcType=DOUBLE}-#{metreDegree,jdbcType=DOUBLE}) and (#{lon,jdbcType=DOUBLE}+#{metreDegree,jdbcType=DOUBLE})
        and d.lat between (#{lat,jdbcType=DOUBLE}-#{metreDegree,jdbcType=DOUBLE}) and (#{lat,jdbcType=DOUBLE}+#{metreDegree,jdbcType=DOUBLE})
        ) t ) t2 where t2.distance &lt;= #{metre,jdbcType=DOUBLE}
    </select>

    <select id="getByPointAroundPageData"  resultMap="MobileResultMap">
        select
        t.*,
        if(ISNULL(lon + lat), 9999999999, st_distance (point(lon, lat), point(#{lon,jdbcType=DOUBLE},#{lat,jdbcType=DOUBLE})) * 111195) AS distance
        from (
        select 
        	a.id, a.activity_id, a.activity_adseat_id, a.task_type,a.monitor_date,a.monitor_last_days, 
        	a.user_id, a.status,a.problem_status,a.sub_created,a.parent_id,a.parent_type, a.verify_time, a.create_time, a.update_time, a.assessor_id,a.assignor_id,
        	b.activity_name,
        	c.sample_pic_url,c.monitor_start,c.monitor_end,c.ad_seat_id,
        	d.`name` as ad_seat_name,d.location as ad_seat_location,d.ad_code as ad_seat_code, d.lon, d.lat, d.region, d.street, d.province, d.city
        from ad_monitor_task a
        left join ad_activity b on a.activity_id = b.id
        left join ad_activity_adseat c on a.activity_adseat_id = c.id
        left join ad_seat_info d on c.ad_seat_id = d.id

        where a.status = 8
        and d.lon between (#{lon,jdbcType=DOUBLE}-#{metreDegree,jdbcType=DOUBLE}) and (#{lon,jdbcType=DOUBLE}+#{metreDegree,jdbcType=DOUBLE})
        and d.lat between (#{lat,jdbcType=DOUBLE}-#{metreDegree,jdbcType=DOUBLE}) and (#{lat,jdbcType=DOUBLE}+#{metreDegree,jdbcType=DOUBLE})
        ) t
        having distance &lt;= #{metre,jdbcType=DOUBLE}
        order by distance,update_time desc
    </select>

    <select id="getByCurCityPageCount" parameterType="map" resultType="int">
        select
        count(a.id)
        from ad_monitor_task a
        left join ad_activity b on a.activity_id = b.id
        left join ad_activity_adseat c on a.activity_adseat_id = c.id
        left join ad_seat_info d on c.ad_seat_id = d.id
        where a.status = 8
        <if test="province!=null">
            and d.province = #{province,jdbcType=BIGINT}
        </if>
        <if test="city!=null">
            and d.city = #{city,jdbcType=BIGINT}
        </if>
    </select>

    <select id="getByCurCityPageData" resultMap="MobileResultMap">
        select t.*
        <if test="lon!=null and lat!=null">
          ,if(ISNULL(lon + lat), 9999999999, st_distance (point(lon, lat), point(#{lon,jdbcType=DOUBLE},#{lat,jdbcType=DOUBLE})) * 111195) AS distance
        </if>
        from (
        select 
        	a.id, a.activity_id, a.activity_adseat_id, a.task_type,a.monitor_date,a.monitor_last_days, 
        	a.user_id, a.status,a.problem_status,a.sub_created,a.parent_id,a.parent_type, a.verify_time, a.create_time, a.update_time, a.assessor_id,a.assignor_id,
       		b.activity_name,
       		c.sample_pic_url,c.monitor_start,c.monitor_end,c.ad_seat_id,
       		d.`name` as ad_seat_name,d.location as ad_seat_location,d.ad_code as ad_seat_code, d.lon, d.lat, d.region, d.street, d.province, d.city
        from ad_monitor_task a
        left join ad_activity b on a.activity_id = b.id
        left join ad_activity_adseat c on a.activity_adseat_id = c.id
        left join ad_seat_info d on c.ad_seat_id = d.id

        where a.status = 8
        <if test="province!=null">
          and d.province = #{province,jdbcType=BIGINT}
        </if>
        <if test="city!=null">
          and d.city = #{city,jdbcType=BIGINT}
        </if>
        ) t

        order by
        <if test="lon!=null and lat!=null">
            distance,
        </if>
        update_time desc
    </select>
    
    <update id="grabTask">
        update ad_monitor_task set
        user_id = #{userId,jdbcType=INTEGER}
        ,status = 2
        ,update_time = sysdate()
        where
        id = #{id,jdbcType=INTEGER}
        and user_id is null
        and update_time = #{updateTime,jdbcType=TIMESTAMP}
    </update>

    <select id="getPageDataAllTask" parameterType="map" resultType="com.bt.om.entity.vo.AllAdMonitorTaskVo">
        select
        	a.id, 
        	a.activity_id as activityId, 
        	a.activity_adseat_id as activityAdseatId, 
        	a.task_type as taskType, 
        	a.monitor_date as monitorDate,
        	a.monitor_last_days as monitorLastDays,
        	a.user_id as userId,
	        a.status as status,
	        a.problem_status as problemStatus,
	        a.assessor_id as assessorId,
	        a.assignor_id as assignorId,
	        b.activity_name as activityName,
	        d.name as seatInfoName,
	        e.realname as userRealName,
	        f.realname as assessorName,
	        g.realname as assignorName
        from ad_monitor_task a
        	left join ad_activity b on a.activity_id = b.id
	        left join ad_activity_adseat c on a.activity_adseat_id = c.id
	        left join ad_seat_info d on c.ad_seat_id = d.id
	        left join sys_user_execute e on a.user_id = e.id
	        left join sys_user f on a.assessor_id=f.id
	        left join sys_user g on a.assignor_id=g.id
        where 1=1
        <if test="activityId != null">
            and a.activity_id = #{activityId,jdbcType=INTEGER}
        </if>
        <if test="status != null">
            and a.status = #{status,jdbcType=INTEGER}
        </if>

        <if test="problemStatus != null">
            and a.problem_status = #{problemStatus,jdbcType=INTEGER}
        </if>

        <if test="taskType != null">
            and a.task_type = #{taskType,jdbcType=INTEGER}
        </if>
     
        <if test="monitorDate != null">
            and a.monitor_date >= DATE_FORMAT(#{monitorDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>
     
        order by a.update_time desc,a.id desc
    </select>
    <select id="getPageCountAllTask" parameterType="map" resultType="int">
        select count(a.id)
        from ad_monitor_task a
        where 1=1
        <if test="activityId != null">
            and a.activity_id = #{activityId,jdbcType=INTEGER}
        </if>
        <if test="status != null">
            and a.status = #{status,jdbcType=INTEGER}
        </if>
     
        <if test="problemStatus != null">
            and a.problem_status = #{problemStatus,jdbcType=INTEGER}
        </if>
    
        <if test="taskType != null">
            and a.task_type = #{taskType,jdbcType=INTEGER}
        </if>
     
     	<if test="monitorDate != null">
            and a.monitor_date >= DATE_FORMAT(#{monitorDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>
    </select>
	
	<!-- 获取当前登录员工admin获取自己曾经捞取过的监测任务  -->    
    <select id="selectAllByAssessorId" parameterType="map" resultMap="ExtResultMap">
        select 
        	a.id, a.activity_id, a.activity_adseat_id, a.task_type, a.monitor_date,a.monitor_last_days,a.user_id,
	        a.status,a.problem_status,a.sub_created,a.parent_id,a.parent_type, a.verify_time, a.create_time, a.update_time,a.assessor_id,a.assignor_id,
	        b.activity_name,
	        c.sample_pic_url, c.media_id,
	        b.start_time,b.end_time,
	        d.province,d.city,d.region,d.street,
	        e.media_name,d.`name` as ad_seat_name,
	        f.realname
        from 
        	ad_monitor_task a
	        left join ad_activity b on a.activity_id = b.id
	        left join ad_activity_adseat c on a.activity_adseat_id = c.id
	        left join ad_seat_info d on c.ad_seat_id = d.id
	        left join ad_media e on c.media_id = e.id
	        left join sys_user_execute f on a.user_id = f.id
        where 1=1
        <if test="activityId != null">
            and a.activity_id = #{activityId,jdbcType=INTEGER}
        </if>
        <if test="status != null">
            and a.status = #{status,jdbcType=INTEGER}
        </if>
        <if test="statuses != null">
            and a.status in
            <foreach collection="statuses" separator="," open="(" close=")" item="s">#{s,jdbcType=INTEGER}
            </foreach>
        </if>
        <if test="problemStatus != null">
            and a.problem_status = #{problemStatus,jdbcType=INTEGER}
        </if>
        <if test="problemStatuses != null">
            and a.problem_status in
            <foreach collection="problemStatuses" separator="," open="(" close=")" item="ps">#{ps,jdbcType=INTEGER}
            </foreach>
        </if>
        <if test="taskType != null">
            and a.task_type = #{taskType,jdbcType=INTEGER}
        </if>
        <if test="mediaUserId != null">
            and e.user_id = #{mediaUserId,jdbcType=INTEGER} and a.parent_id is null
        </if>
        <if test="taskTypes != null">
            and a.task_type in
            <foreach collection="taskTypes" separator="," open="(" close=")" item="task">#{task,jdbcType=INTEGER}
            </foreach>
        </if>
        <if test="parentId != null">
            and a.parent_id = #{parentId,jdbcType=INTEGER}
        </if>
        <if test="parentType != null">
            and a.parent_type = #{parentType,jdbcType=INTEGER}
        </if>
        <if test="idpid != null">
            and (a.id = #{idpid,jdbcType=INTEGER} or a.parent_id = #{idpid,jdbcType=INTEGER} and a.parent_type=1)
        </if>
        <if test="startDate != null">
            and b.start_time >= DATE_FORMAT(#{startDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>
        <if test="endDate != null">
            and b.end_time &lt;= DATE_FORMAT(#{endDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
        </if>
        <if test="assessorId != null" >
	      	and a.assessor_id = #{assessorId,jdbcType=INTEGER}
	    </if>
	    <if test="assignorId != null" >
	      	and a.assignor_id = #{assignorId,jdbcType=INTEGER}
	    </if>
        order by a.update_time desc,a.id desc
    </select>
    
    <!-- 获取当前登录员工admin获取自己曾经捞取过的监测任务  -->    
    <select id="getTenAdMonitorTaskVo" parameterType="map" resultMap="ExtResultMap">
        select 
        	a.id, a.activity_id, a.activity_adseat_id, a.task_type, a.monitor_date,a.monitor_last_days,a.user_id,
	        a.status,a.problem_status,a.sub_created,a.parent_id,a.parent_type, a.verify_time, a.create_time, a.update_time,a.assessor_id,a.assignor_id,
	        b.activity_name,
	        c.sample_pic_url, c.media_id,
	        b.start_time,b.end_time,
	        d.province,d.city,d.region,d.street,
	        e.media_name,d.`name` as ad_seat_name,
	        f.realname
        from 
        	ad_monitor_task a
	        left join ad_activity b on a.activity_id = b.id
	        left join ad_activity_adseat c on a.activity_adseat_id = c.id
	        left join ad_seat_info d on c.ad_seat_id = d.id
	        left join ad_media e on c.media_id = e.id
	        left join sys_user_execute f on a.user_id = f.id
        where 1=1
        <if test="status != null" >
	      and a.status = #{status,jdbcType=INTEGER}
	    </if>
	    <if test="assessorId != null" >
	      and a.assessor_id is null
	    </if>
      	<if test="assignorId != null" >
	      and a.assignor_id is null
	    </if>
	    <if test="customerIds != null">
	      and b.user_id in
	        <foreach collection="customerIds" separator="," open="(" close=")" item="id">#{id,jdbcType=INTEGER}</foreach>
	    </if>
	    order by a.id limit 0,10 for update;
    </select>
    <update id="updateAssessorId" parameterType="map">
	  	update ad_monitor_task
	    set
	      assessor_id = #{assessorId,jdbcType=INTEGER}
	    where 1=1
	    <if test="ids != null">
	      and id in
	        <foreach collection="ids" separator="," open="(" close=")" item="id">#{id,jdbcType=INTEGER}</foreach>
	    </if>
    </update>  
    <update id="updateAssignorId" parameterType="map">
	  	update ad_monitor_task
	    set
	      assignor_id = #{assignorId,jdbcType=INTEGER}
	    where 1=1
	    <if test="ids != null">
	      and id in
	        <foreach collection="ids" separator="," open="(" close=")" item="id">#{id,jdbcType=INTEGER}</foreach>
	    </if>
    </update>
  
    <select id="selectLatestMonitorTaskIds" resultType="com.bt.om.entity.AdMonitorTask" parameterType="int">
    	select a.id id, a.activity_adseat_id activityAdseatId
		from (
			select id, activity_id, activity_adseat_id, monitor_date
			from ad_monitor_task
			where activity_id = #{activityId,jdbcType=INTEGER}
			order by monitor_date desc
		) as a 
		group by a.activity_adseat_id;
    </select>
    
    <update id="activateMonitorTask" parameterType="java.util.Date">
    	update ad_monitor_task
	    set status = 
	    case when monitor_last_days = 1 then 1
	    else 8
	    end
	    where status = 7 and 
	    monitor_date &lt;= DATE_FORMAT(#{endDate,jdbcType=TIMESTAMP},'%Y-%m-%d')
    </update>
    
    <!-- 
    	任务回收：
    	monitor_date + monitor_last_days - 2天 + 12小时 < now 
    	可推出 monitor_date < now - monitor_last_days + 2天 - 12小时 时改为1：可指派，否则为8：可抢单
    -->
    <update id="recycleTask">
    	update ad_monitor_task
    	set
	    	user_id = null,
	    	update_time = CURRENT_TIMESTAMP,
	    	status = 
	    	case when monitor_date &lt;= date_add(date_add(now(),interval (2 - monitor_last_days) day),interval -#{duration,jdbcType=INTEGER} hour) then 1
	    	else 8
	    	end
    	where id in 
    	<foreach collection="monitorTaskIds" separator="," open="(" close=")" item="s">#{s,jdbcType=INTEGER}
        </foreach>
        and status in (2, 6)
    </update>
    
    <!-- 
    	没人抢单的任务改为强制指派
    	monitor_date + monitor_last_days - 2天 + 12小时 < now 
    	可推出 monitor_date < now - monitor_last_days + 2天 - 12小时 时改为1：可指派，否则为8：可抢单
    -->
    <update id="forceAssignTask">
    	update ad_monitor_task
    	set
	    	update_time = CURRENT_TIMESTAMP,
	    	status = 1
    	where status = 8
    	and monitor_date &lt;= date_add(date_add(now(),interval (2 - monitor_last_days) day),interval -#{duration,jdbcType=INTEGER} hour)
    </update>
    <select id="getAllByStatusUnCheck" parameterType="map" resultMap="BaseResultMap">
  		select
    	<include refid="Base_Column_List" />
    	from ad_monitor_task
    	where  1 = 1 and status = 3
     	<if test="customerIds != null">
     		 and user_id in
        	<foreach collection="customerIds" separator="," open="(" close=")" item="id">#{id,jdbcType=INTEGER}</foreach>
    	</if> 
  </select>
    <select id="getAllByStatusUnZhipai" parameterType="map" resultMap="BaseResultMap">
  		select
    	<include refid="Base_Column_List" />
    	from ad_monitor_task
    	where  1 = 1 and status = 1
   		<if test="customerIds != null">
     		 and user_id in
        	<foreach collection="customerIds" separator="," open="(" close=")" item="id">#{id,jdbcType=INTEGER}</foreach>
    	</if> 
  </select>
    
    <!-- 查询每条监测任务中最新的一条反馈信息 -->
    <select id="selectFeedBackByActivityIdAndSeatId" parameterType="map" resultType="com.bt.om.entity.vo.PictureVo">
    	select
			* 
		from (
			select 
				a.task_type taskType,
				b.monitor_task_id, 
				b.pic_url1 pic1,
				b.pic_url2 pic2,
				b.pic_url3 pic3,
				b.pic_url4 pic4,
				b.create_time date,
				b.problem,
				b.problem_other problemOther,
				c.realname userName
			from ad_monitor_task a
			left join ad_monitor_task_feedback b on b.monitor_task_id = a.id
			left join sys_user_execute c on c.id = a.user_id
			where 
				a.activity_id = #{activityId,jdbcType=INTEGER} and a.activity_adseat_id = #{activityAdseatId,jdbcType=INTEGER}
			order by b.create_time desc
		) as t
		group by monitor_task_id
    </select>
    
</mapper>